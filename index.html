<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gym Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Syne:wght@700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;}

:root[data-theme="dark"]{
  --bg:#080c10;--bg2:#0d1117;--bg3:#131920;--bg4:#1a2230;
  --border:#1e2d3d;--border2:#243447;
  --text:#e2eaf4;--text2:#7a8fa6;--text3:#3d5269;
  --accent:#00d4ff;--accent2:#0096b3;--accent-bg:rgba(0,212,255,0.08);
  --accent-glow:rgba(0,212,255,0.25);
  --cell-bg:#0d1117;--cell-bdr:#1e2d3d;
  --input-bg:#0d1117;--shadow:rgba(0,0,0,0.6);
  --warn:#f59e0b;--warn-bg:#f59e0b12;
  --danger:#ff4757;--danger-bg:#ff475712;
  --ok:#00e676;--ok-bg:#00e67612;
  --green:#00e676;--yellow:#ffd600;--red:#ff4757;
}
:root[data-theme="light"]{
  --bg:#f2f5f9;--bg2:#ffffff;--bg3:#eaf0f8;--bg4:#dde8f5;
  --border:#d0dcea;--border2:#b8cce0;
  --text:#0d1a2e;--text2:#4a6885;--text3:#a8bdd4;
  --accent:#0077cc;--accent2:#005ea3;--accent-bg:rgba(0,119,204,0.08);
  --accent-glow:rgba(0,119,204,0.2);
  --cell-bg:#f8fbff;--cell-bdr:#d0dcea;
  --input-bg:#eaf0f8;--shadow:rgba(0,0,0,0.08);
  --warn:#d97706;--warn-bg:#fef3c7;
  --danger:#dc2626;--danger-bg:#fee2e2;
  --ok:#059669;--ok-bg:#d1fae5;
  --green:#059669;--yellow:#d97706;--red:#dc2626;
}

body{min-height:100vh;background:var(--bg);color:var(--text);font-family:'Space Grotesk','Helvetica Neue',sans-serif;transition:background .3s,color .3s;overflow-x:hidden;}

/* Subtle grain texture overlay */
body::before{content:"";position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.03;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");}

.app-container{max-width:1040px;margin:0 auto;padding:32px 20px;position:relative;z-index:1;}

/* ‚îÄ‚îÄ‚îÄ ALERT BANNER ‚îÄ‚îÄ‚îÄ */
#global-alert{
  display:none;position:fixed;top:0;left:0;right:0;z-index:1000;
  padding:12px 24px;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  font-size:13px;flex-wrap:wrap;
  backdrop-filter:blur(20px);
  border-bottom:1px solid rgba(255,255,255,0.1);
  animation:slideDown .4s cubic-bezier(.16,1,.3,1);
}
#global-alert.danger{background:rgba(255,71,87,0.92);color:#fff;}
#global-alert.warn{background:rgba(245,158,11,0.92);color:#fff;}
#global-alert.hidden{display:none!important;}
@keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}
.alert-left{display:flex;align-items:center;gap:10px;}
.alert-icon{font-size:18px;}
.alert-text strong{display:block;font-size:13px;font-weight:700;letter-spacing:.3px;}
.alert-text span{font-size:12px;opacity:.9;}
.alert-actions{display:flex;gap:8px;align-items:center;}
.alert-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.35);color:#fff;border-radius:6px;padding:5px 14px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:background .15s;letter-spacing:.4px;}
.alert-btn:hover{background:rgba(255,255,255,0.32);}
.alert-close{background:none;border:none;color:rgba(255,255,255,0.7);font-size:18px;cursor:pointer;padding:0 4px;line-height:1;transition:color .15s;}
.alert-close:hover{color:#fff;}
#app-content{transition:margin-top .4s;}

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
.modal-overlay{display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:16px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border-radius:20px;padding:32px;max-width:460px;width:100%;box-shadow:0 32px 80px rgba(0,0,0,.6),0 0 0 1px var(--border2);animation:popIn .35s cubic-bezier(.16,1,.3,1);}
@keyframes popIn{from{transform:scale(.92);opacity:0}to{transform:scale(1);opacity:1}}
.modal-icon{font-size:44px;text-align:center;margin-bottom:12px;}
.modal-title{font-family:'Syne',sans-serif;font-size:20px;letter-spacing:-.3px;text-align:center;margin-bottom:4px;font-weight:800;}
.modal-subtitle{color:var(--text2);font-size:13px;text-align:center;margin-bottom:20px;}
.modal-pay-list{display:flex;flex-direction:column;gap:8px;margin-bottom:20px;}
.modal-pay-item{border-radius:10px;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;}
.modal-pay-item.danger{background:var(--danger-bg);border:1px solid var(--danger);}
.modal-pay-item.warn{background:var(--warn-bg);border:1px solid var(--warn);}
.modal-pay-name{font-size:13px;font-weight:600;}
.modal-pay-meta{font-size:11px;color:var(--text2);margin-top:2px;}
.modal-pay-right{text-align:right;}
.modal-pay-amount{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:500;}
.modal-pay-badge{font-size:10px;padding:2px 8px;border-radius:20px;font-weight:600;letter-spacing:.5px;}
.modal-pay-badge.danger{background:var(--danger-bg);color:var(--danger);border:1px solid var(--danger);}
.modal-pay-badge.warn{background:var(--warn-bg);color:var(--warn);border:1px solid var(--warn);}
.modal-footer{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
.modal-btn{border:none;border-radius:8px;padding:10px 22px;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;letter-spacing:.3px;}
.modal-btn.primary{background:var(--accent);color:#000;}
.modal-btn.secondary{background:var(--bg3);color:var(--text2);border:1px solid var(--border2);}
.modal-btn:hover{opacity:.85;transform:translateY(-1px);}

/* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
.top-bar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;margin-bottom:28px;}
.brand{display:flex;align-items:baseline;gap:12px;}
h1{font-family:'Syne',sans-serif;font-size:clamp(26px,4vw,38px);letter-spacing:-.5px;line-height:1;background:linear-gradient(135deg,var(--text) 0%,var(--accent) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:800;}
.brand-sub{font-size:11px;color:var(--text3);font-weight:600;letter-spacing:3px;text-transform:uppercase;padding-bottom:4px;}

.theme-toggle{background:none;border:1px solid var(--border2);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:border-color .2s,background .2s;font-size:16px;}
.theme-toggle:hover{border-color:var(--accent);background:var(--accent-bg);}
.theme-toggle span{display:none;}
.theme-toggle span.active{display:block;}

/* ‚îÄ‚îÄ‚îÄ NAV TABS ‚îÄ‚îÄ‚îÄ */
.nav-tabs{display:flex;gap:2px;background:var(--bg2);border-radius:10px;padding:4px;margin-bottom:28px;flex-wrap:wrap;border:1px solid var(--border);}
.tab-btn{padding:9px 18px;border-radius:7px;border:none;background:transparent;color:var(--text2);font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;position:relative;letter-spacing:.3px;}
.tab-btn.active{background:var(--accent);color:#000;box-shadow:0 2px 12px var(--accent-glow);}
.tab-btn:hover:not(.active){background:var(--bg3);color:var(--text);}
.tab-badge{position:absolute;top:6px;right:8px;width:7px;height:7px;border-radius:50%;background:var(--danger);box-shadow:0 0 6px var(--danger);}

.section{display:none;}
.section.active{display:block;}

/* ‚îÄ‚îÄ‚îÄ YEAR NAV ‚îÄ‚îÄ‚îÄ */
.year-nav{display:flex;align-items:center;gap:8px;}
.year-btn{background:var(--bg2);border:1px solid var(--border2);color:var(--text);padding:7px 14px;border-radius:7px;cursor:pointer;font-family:inherit;font-size:13px;font-weight:600;transition:all .2s;}
.year-btn:hover{background:var(--bg3);border-color:var(--accent);}
.year-display{font-family:'JetBrains Mono',monospace;font-size:18px;min-width:56px;text-align:center;color:var(--accent);font-weight:500;}

/* ‚îÄ‚îÄ‚îÄ LEGEND ‚îÄ‚îÄ‚îÄ */
.legend{display:flex;gap:18px;flex-wrap:wrap;align-items:center;margin-bottom:20px;font-size:12px;}
.legend-item{display:flex;align-items:center;gap:6px;color:var(--text2);font-weight:500;letter-spacing:.2px;}
.legend-dot{width:10px;height:10px;border-radius:3px;}
.legend-hint{color:var(--text3);font-size:11px;margin-left:auto;letter-spacing:.5px;}

/* ‚îÄ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ‚îÄ */
.stats-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:28px;}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px 20px;display:flex;flex-direction:column;align-items:center;min-width:80px;box-shadow:0 2px 12px var(--shadow);}
.stat-num{font-family:'JetBrains Mono',monospace;font-size:32px;line-height:1;font-weight:500;}
.stat-lbl{font-size:10px;color:var(--text2);margin-top:4px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;}

/* ‚îÄ‚îÄ‚îÄ MONTH GRID ‚îÄ‚îÄ‚îÄ */
#months-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(286px,1fr));gap:14px;}
.month-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;transition:border-color .2s,box-shadow .2s;box-shadow:0 2px 12px var(--shadow);}
.month-card:hover{border-color:var(--border2);box-shadow:0 4px 20px var(--shadow);}
.month-card.current{border-color:var(--accent);box-shadow:0 4px 24px var(--accent-glow);}
.month-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;}
.month-name{font-family:'Syne',sans-serif;font-size:15px;letter-spacing:-.3px;font-weight:800;}
.month-name.current-name{color:var(--accent);}
.month-mini-stats{display:flex;gap:8px;margin-top:4px;font-size:11px;font-weight:500;}
.current-badge{font-size:9px;color:var(--accent);background:var(--accent-bg);padding:3px 10px;border-radius:20px;font-weight:700;letter-spacing:1px;}
.dow-header{display:grid;grid-template-columns:repeat(7,32px);gap:3px;margin-bottom:4px;}
.dow-cell{width:32px;text-align:center;font-size:10px;color:var(--text3);font-weight:600;letter-spacing:.3px;}
.days-grid{display:grid;grid-template-columns:repeat(7,32px);gap:3px;}
.day-cell{width:32px;height:32px;border-radius:6px;border:1px solid var(--cell-bdr);background:var(--cell-bg);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--text3);transition:transform .12s,border-color .2s;user-select:none;font-family:'JetBrains Mono',monospace;}
.day-cell:hover{transform:scale(1.15);border-color:var(--accent);}
.day-cell.empty{opacity:0;pointer-events:none;}
.day-cell.green{background:rgba(0,230,118,.1);border-color:var(--green);color:var(--green);}
.day-cell.yellow{background:rgba(255,214,0,.1);border-color:var(--yellow);color:var(--yellow);}
.day-cell.red{background:rgba(255,71,87,.1);border-color:var(--red);color:var(--red);}
.day-cell.today{outline:2px solid var(--accent);outline-offset:1px;}

.two-col{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
@media(max-width:640px){.two-col{grid-template-columns:1fr;}}

/* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:22px;box-shadow:0 2px 12px var(--shadow);margin-bottom:16px;}
.card h2{font-family:'Syne',sans-serif;font-size:14px;letter-spacing:0px;margin-bottom:16px;color:var(--accent);font-weight:700;display:flex;align-items:center;gap:8px;}
.card h2::before{content:"";display:block;width:3px;height:13px;background:var(--accent);border-radius:2px;}

/* ‚îÄ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ‚îÄ */
.form-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
.form-input{flex:1;min-width:100px;background:var(--input-bg);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-family:'Space Grotesk',sans-serif;font-size:13px;padding:9px 13px;outline:none;transition:border-color .2s,box-shadow .2s;}
.form-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-bg);}
textarea.form-input{resize:vertical;min-height:56px;}
.btn-add{background:var(--accent);border:none;border-radius:8px;color:#000;font-family:inherit;font-size:13px;font-weight:700;padding:9px 18px;cursor:pointer;transition:all .2s;white-space:nowrap;letter-spacing:.3px;}
.btn-add:hover{opacity:.85;transform:translateY(-1px);box-shadow:0 4px 14px var(--accent-glow);}
.btn-del{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:2px 6px;transition:color .2s;border-radius:4px;}
.btn-del:hover{color:var(--danger);background:var(--danger-bg);}

/* ‚îÄ‚îÄ‚îÄ LOG LIST ‚îÄ‚îÄ‚îÄ */
.log-list{display:flex;flex-direction:column;gap:6px;max-height:300px;overflow-y:auto;}
.log-list::-webkit-scrollbar{width:4px;}
.log-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.log-item{display:flex;justify-content:space-between;align-items:center;background:var(--bg3);border-radius:8px;padding:9px 13px;font-size:13px;border:1px solid var(--border);}
.log-item-left{display:flex;flex-direction:column;}
.log-date{color:var(--text2);font-size:11px;font-family:'JetBrains Mono',monospace;margin-top:1px;}
.log-val{font-weight:600;font-family:'JetBrains Mono',monospace;font-size:14px;}
.log-note{color:var(--text2);font-size:11px;margin-top:2px;}

/* ‚îÄ‚îÄ‚îÄ WEIGHT ‚îÄ‚îÄ‚îÄ */
.weight-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;}
.weight-stat{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center;}
.ws-num{font-family:'JetBrains Mono',monospace;font-size:26px;color:var(--accent);font-weight:500;}
.ws-lbl{font-size:10px;color:var(--text2);margin-top:4px;font-weight:600;letter-spacing:.6px;text-transform:uppercase;}
.chart-wrap{width:100%;height:140px;position:relative;}

/* ‚îÄ‚îÄ‚îÄ DIET ‚îÄ‚îÄ‚îÄ */
.diet-status-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
.diet-status-btn{flex:1;padding:9px;border-radius:8px;border:1px solid var(--border2);background:var(--bg3);color:var(--text2);font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;text-align:center;letter-spacing:.3px;}
.diet-status-btn.sel-green{background:rgba(0,230,118,.1);border-color:var(--green);color:var(--green);}
.diet-status-btn.sel-yellow{background:rgba(255,214,0,.1);border-color:var(--yellow);color:var(--yellow);}
.diet-status-btn.sel-red{background:rgba(255,71,87,.1);border-color:var(--red);color:var(--red);}
.diet-cal-header{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:4px;}
.diet-cal-dow{text-align:center;font-size:10px;color:var(--text3);font-weight:600;letter-spacing:.3px;}
.diet-cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
.diet-dot{aspect-ratio:1;border-radius:5px;background:var(--bg3);border:1px solid var(--border);}
.diet-dot.green{background:rgba(0,230,118,.15);border-color:var(--green);}
.diet-dot.yellow{background:rgba(255,214,0,.15);border-color:var(--yellow);}
.diet-dot.red{background:rgba(255,71,87,.15);border-color:var(--red);}
.diet-log-item{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:11px 14px;font-size:13px;margin-bottom:6px;}
.diet-log-header{display:flex;justify-content:space-between;align-items:center;}
.diet-log-date{font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace;}
.diet-badge{font-size:10px;padding:3px 10px;border-radius:20px;font-weight:700;letter-spacing:.4px;}
.diet-badge.green{background:rgba(0,230,118,.12);color:var(--green);}
.diet-badge.yellow{background:rgba(255,214,0,.12);color:var(--yellow);}
.diet-badge.red{background:rgba(255,71,87,.12);color:var(--red);}
.diet-log-food{color:var(--text2);font-size:11px;margin-top:5px;}
.diet-log-notes{color:var(--text3);font-size:11px;margin-top:2px;font-style:italic;}

/* ‚îÄ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ‚îÄ */
.section-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:22px;}
.section-header h2{font-family:'Syne',sans-serif;font-size:20px;letter-spacing:0px;font-weight:800;}

/* ‚îÄ‚îÄ‚îÄ PAYMENTS ‚îÄ‚îÄ‚îÄ */
.pay-item{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px 18px;margin-bottom:10px;box-shadow:0 2px 12px var(--shadow);display:flex;align-items:center;gap:14px;transition:border-color .2s,box-shadow .2s;}
.pay-item.urgent{border-color:var(--danger);box-shadow:0 4px 20px rgba(255,71,87,.15);}
.pay-item.soon{border-color:var(--warn);box-shadow:0 4px 20px rgba(245,158,11,.1);}
.pay-left{flex:1;}
.pay-name{font-size:14px;font-weight:700;letter-spacing:-.2px;}
.pay-meta{font-size:11px;color:var(--text2);margin-top:4px;font-family:'JetBrains Mono',monospace;}
.pay-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px;}
.pay-amount{font-family:'JetBrains Mono',monospace;font-size:22px;color:var(--accent);font-weight:500;}
.pay-badge{font-size:10px;padding:3px 10px;border-radius:20px;white-space:nowrap;font-weight:700;letter-spacing:.5px;}
.pay-badge.danger{background:var(--danger-bg);color:var(--danger);border:1px solid rgba(255,71,87,.3);}
.pay-badge.warn{background:var(--warn-bg);color:var(--warn);border:1px solid rgba(245,158,11,.3);}
.pay-badge.ok{background:var(--ok-bg);color:var(--ok);border:1px solid rgba(0,230,118,.3);}
.pay-actions{display:flex;gap:4px;align-items:center;}
.btn-paid{background:var(--ok-bg);border:1px solid rgba(0,230,118,.3);color:var(--ok);border-radius:7px;padding:5px 12px;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;letter-spacing:.3px;}
.btn-paid:hover{opacity:.75;}
.recur-options{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;}
.recur-btn{padding:6px 14px;border-radius:7px;border:1px solid var(--border2);background:var(--bg3);color:var(--text2);font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;letter-spacing:.2px;}
.recur-btn.active{background:var(--accent);border-color:var(--accent);color:#000;}

/* ‚îÄ‚îÄ‚îÄ RUTINA ‚îÄ‚îÄ‚îÄ */
.today-routine{background:var(--bg2);border:1px solid var(--accent);border-radius:16px;padding:22px;margin-bottom:20px;box-shadow:0 8px 32px var(--accent-glow),inset 0 0 40px var(--accent-bg);position:relative;overflow:hidden;}
.today-routine::after{content:"";position:absolute;top:-40px;right:-40px;width:160px;height:160px;border-radius:50%;background:var(--accent-glow);filter:blur(40px);pointer-events:none;}
.today-routine h3{font-size:10px;color:var(--accent);font-weight:700;letter-spacing:2.5px;text-transform:uppercase;margin-bottom:4px;}
.today-routine .routine-day-name{font-family:'Syne',sans-serif;font-size:22px;letter-spacing:-.5px;margin-bottom:12px;font-weight:800;}
.exercise-list{display:flex;flex-direction:column;gap:8px;}

/* Exercise chip: nombre + series/reps + peso */
.exercise-chip{background:var(--bg3);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:13px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.ex-num{color:var(--accent);font-size:11px;min-width:18px;font-family:'JetBrains Mono',monospace;font-weight:500;flex-shrink:0;}
.ex-name{flex:1;font-weight:600;font-size:13px;min-width:80px;}
.ex-pills{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
.ex-pill{background:var(--accent-bg);border:1px solid rgba(0,212,255,.2);color:var(--accent);border-radius:6px;padding:3px 9px;font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:500;white-space:nowrap;}
.ex-pill.weight{background:rgba(0,230,118,.08);border-color:rgba(0,230,118,.25);color:var(--green);}

/* Editor de rutina */
.day-tabs{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:16px;}
.day-tab{padding:7px 14px;border-radius:7px;border:1px solid var(--border2);background:var(--bg3);color:var(--text2);font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;letter-spacing:.3px;}
.day-tab.active{background:var(--accent);border-color:var(--accent);color:#000;}
.exercise-editor{display:flex;flex-direction:column;gap:8px;margin-bottom:12px;max-height:320px;overflow-y:auto;}
.ex-row{display:flex;gap:6px;align-items:flex-start;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:10px 12px;}
.ex-row-fields{display:flex;gap:6px;flex:1;flex-wrap:wrap;}
.ex-row-fields .form-input{font-size:12px;padding:7px 10px;}
.ex-input-name{width:100%;min-width:0;}
.ex-input-sm{flex:1;min-width:70px;}
.ex-input-peso{flex:1;min-width:70px;max-width:90px;}

/* Inline weight input in today view */
.ex-weight-inline{display:flex;align-items:center;gap:4px;flex-shrink:0;}
.ex-weight-input{width:60px;background:var(--input-bg);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;padding:4px 8px;outline:none;text-align:center;transition:border-color .2s;}
.ex-weight-input:focus{border-color:var(--green);}
.ex-weight-unit{font-size:11px;color:var(--text3);font-weight:500;}

/* ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ */
.footer{text-align:center;margin-top:48px;color:var(--text3);font-size:11px;letter-spacing:.8px;font-weight:500;}
.footer span{color:var(--accent);opacity:.6;}

::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ GLOBAL ALERT BANNER ‚îÄ‚îÄ -->
<div id="global-alert" class="hidden">
  <div class="alert-left">
    <span class="alert-icon" id="alert-icon"></span>
    <div class="alert-text">
      <strong id="alert-title"></strong>
      <span id="alert-body"></span>
    </div>
  </div>
  <div class="alert-actions">
    <button class="alert-btn" onclick="showTab('pagos');closeAlert()">Ver pagos</button>
    <button class="alert-close" onclick="closeAlert()">‚úï</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="pay-modal">
  <div class="modal">
    <div class="modal-icon" id="modal-icon"></div>
    <div class="modal-title" id="modal-title"></div>
    <div class="modal-subtitle" id="modal-subtitle"></div>
    <div class="modal-pay-list" id="modal-pay-list"></div>
    <div class="modal-footer">
      <button class="modal-btn primary" onclick="showTab('pagos');closeModal()">Ver todos los pagos</button>
      <button class="modal-btn secondary" onclick="closeModal()">Cerrar</button>
    </div>
  </div>
</div>

<div class="app-container" id="app-content">
  <div class="top-bar">
    <div class="brand">
      <h1>GYM TRACKER</h1>
      <span class="brand-sub">Personal</span>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">
      <span id="th-dark" class="active">üåô</span>
      <span id="th-light">‚òÄÔ∏è</span>
    </button>
  </div>

  <div class="nav-tabs">
    <button class="tab-btn active" onclick="showTab('gym')">üèãÔ∏è Gym</button>
    <button class="tab-btn" onclick="showTab('rutina')">üìã Rutina</button>
    <button class="tab-btn" id="tab-pagos" onclick="showTab('pagos')">üí≥ Pagos</button>
    <button class="tab-btn" onclick="showTab('peso')">‚öñÔ∏è Peso</button>
    <button class="tab-btn" onclick="showTab('dieta')">ü•ó Dieta</button>
  </div>

  <!-- ‚ïê‚ïê GYM ‚ïê‚ïê -->
  <div id="sec-gym" class="section active">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:20px">
      <div class="stats-bar" style="margin-bottom:0">
        <div class="stat-card" style="border-color:rgba(0,230,118,.25)"><span class="stat-num" id="sg" style="color:var(--green)">0</span><span class="stat-lbl">Fui</span></div>
        <div class="stat-card" style="border-color:rgba(255,214,0,.25)"><span class="stat-num" id="sy" style="color:var(--yellow)">0</span><span class="stat-lbl">A medias</span></div>
        <div class="stat-card" style="border-color:rgba(255,71,87,.25)"><span class="stat-num" id="sr" style="color:var(--red)">0</span><span class="stat-lbl">No fui</span></div>
      </div>
      <div class="year-nav">
        <button class="year-btn" onclick="changeYear(-1)">‚óÄ</button>
        <span id="year-display" class="year-display"></span>
        <button class="year-btn" onclick="changeYear(1)">‚ñ∂</button>
      </div>
    </div>
    <div id="months-grid"></div>
  </div>

  <!-- ‚ïê‚ïê RUTINA ‚ïê‚ïê -->
  <div id="sec-rutina" class="section">
    <div class="section-header"><h2>üìã Rutina Semanal</h2></div>
    <div class="today-routine">
      <h3>Hoy es</h3>
      <div class="routine-day-name" id="today-day-name"></div>
      <div id="today-exercises"></div>
    </div>
    <div class="card">
      <h2>Editar rutina</h2>
      <div class="day-tabs" id="day-tabs"></div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:10px;font-weight:600" id="editing-day-label"></div>
      <div class="exercise-editor" id="exercise-editor"></div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:4px">
        <input type="text" id="new-ex-name" class="form-input" placeholder="Ejercicio (ej: Press banca)" style="width:100%"/>
        <div style="display:flex;gap:8px">
          <input type="number" id="new-ex-reps"   class="form-input" placeholder="Reps"   min="1" style="flex:1"/>
          <input type="number" id="new-ex-series" class="form-input" placeholder="Series" min="1" style="flex:1"/>
          <button class="btn-add" onclick="addExercise()" style="flex-shrink:0">+ Agregar</button>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>Semana completa</h2>
      <div id="full-week" style="display:flex;flex-direction:column;gap:10px"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê PAGOS ‚ïê‚ïê -->
  <div id="sec-pagos" class="section">
    <div class="section-header"><h2>üí≥ Pagos del Gym</h2></div>
    <div class="two-col">
      <div>
        <div class="card">
          <h2>Nuevo pago</h2>
          <div class="form-row">
            <input type="text" id="pay-name" class="form-input" placeholder="Nombre (ej: Cuota gym)"/>
          </div>
          <div class="form-row">
            <input type="number" id="pay-amount" class="form-input" placeholder="Monto" min="0" step="0.01"/>
            <input type="text" id="pay-currency" class="form-input" placeholder="$" value="$" style="max-width:64px"/>
          </div>
          <div class="form-row">
            <input type="date" id="pay-date" class="form-input"/>
          </div>
          <div style="font-size:11px;color:var(--text2);margin-bottom:8px;font-weight:600;letter-spacing:.8px;text-transform:uppercase">¬øSe repite?</div>
          <div class="recur-options" id="recur-options">
            <button class="recur-btn active" onclick="selRecur('none',this)">Una vez</button>
            <button class="recur-btn" onclick="selRecur('monthly',this)">Mensual</button>
            <button class="recur-btn" onclick="selRecur('bimonthly',this)">Cada 2 meses</button>
            <button class="recur-btn" onclick="selRecur('yearly',this)">Anual</button>
          </div>
          <div class="form-row">
            <textarea id="pay-notes" class="form-input" placeholder="Notas (opcional)"></textarea>
          </div>
          <button class="btn-add" style="width:100%" onclick="addPayment()">+ Agregar pago</button>
        </div>
      </div>
      <div>
        <div class="card">
          <h2>Pr√≥ximos pagos</h2>
          <div id="pay-list"><div style="color:var(--text3);font-size:12px;text-align:center;padding:24px">Sin pagos registrados</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê PESO ‚ïê‚ïê -->
  <div id="sec-peso" class="section">
    <div class="section-header"><h2>‚öñÔ∏è Registro de Peso</h2></div>
    <div class="two-col">
      <div>
        <div class="card">
          <h2>Agregar</h2>
          <div class="form-row">
            <input type="date" id="w-date" class="form-input"/>
            <input type="number" id="w-kg" class="form-input" placeholder="Peso (kg)" step="0.1" min="30" max="300"/>
          </div>
          <div class="form-row">
            <input type="text" id="w-note" class="form-input" placeholder="Nota (opcional)"/>
            <button class="btn-add" onclick="addWeight()">+ Agregar</button>
          </div>
        </div>
        <div class="card">
          <h2>Resumen</h2>
          <div class="weight-summary">
            <div class="weight-stat"><div class="ws-num" id="w-cur">‚Äî</div><div class="ws-lbl">Actual</div></div>
            <div class="weight-stat"><div class="ws-num" id="w-min">‚Äî</div><div class="ws-lbl">M√≠nimo</div></div>
            <div class="weight-stat"><div class="ws-num" id="w-max">‚Äî</div><div class="ws-lbl">M√°ximo</div></div>
          </div>
          <div id="w-change" style="font-size:12px;color:var(--text2);text-align:center;font-weight:500"></div>
        </div>
      </div>
      <div>
        <div class="card"><h2>Evoluci√≥n</h2><div class="chart-wrap"><canvas id="wChart"></canvas></div></div>
        <div class="card"><h2>Historial</h2><div class="log-list" id="w-list"></div></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê DIETA ‚ïê‚ïê -->
  <div id="sec-dieta" class="section">
    <div class="section-header">
      <h2>ü•ó Registro de Dieta</h2>
      <div class="year-nav">
        <button class="year-btn" onclick="chDietY(-1)">‚óÄ</button>
        <span id="d-year" class="year-display"></span>
        <button class="year-btn" onclick="chDietY(1)">‚ñ∂</button>
      </div>
    </div>
    <div class="two-col">
      <div>
        <div class="card">
          <h2>Registrar d√≠a</h2>
          <div class="form-row"><input type="date" id="d-date" class="form-input"/></div>
          <div style="font-size:11px;color:var(--text2);margin-bottom:8px;font-weight:600;letter-spacing:.8px;text-transform:uppercase">¬øSeguiste la dieta hoy?</div>
          <div class="diet-status-row">
            <button class="diet-status-btn" id="dsb-green" onclick="selDS('green')">‚úÖ Completa</button>
            <button class="diet-status-btn" id="dsb-yellow" onclick="selDS('yellow')">‚ö° A medias</button>
            <button class="diet-status-btn" id="dsb-red" onclick="selDS('red')">‚ùå No segu√≠</button>
          </div>
          <div class="form-row" style="margin-top:8px">
            <textarea id="d-food" class="form-input" placeholder="¬øQu√© comiste?"></textarea>
          </div>
          <div class="form-row">
            <textarea id="d-notes" class="form-input" placeholder="Notas..." style="min-height:48px"></textarea>
            <button class="btn-add" onclick="addDiet()" style="align-self:flex-end">+ Guardar</button>
          </div>
        </div>
        <div class="card">
          <h2>Stats del a√±o</h2>
          <div class="stats-bar" style="margin-bottom:0">
            <div class="stat-card" style="border-color:rgba(0,230,118,.25);flex:1"><span class="stat-num" id="ds-g" style="color:var(--green)">0</span><span class="stat-lbl">Completa</span></div>
            <div class="stat-card" style="border-color:rgba(255,214,0,.25);flex:1"><span class="stat-num" id="ds-y" style="color:var(--yellow)">0</span><span class="stat-lbl">A medias</span></div>
            <div class="stat-card" style="border-color:rgba(255,71,87,.25);flex:1"><span class="stat-num" id="ds-r" style="color:var(--red)">0</span><span class="stat-lbl">No segu√≠</span></div>
          </div>
        </div>
      </div>
      <div>
        <div class="card">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <button class="year-btn" style="padding:5px 11px;font-size:12px" onclick="chDietM(-1)">‚óÄ</button>
            <span id="d-month-lbl" style="font-family:'Syne',sans-serif;font-size:15px;flex:1;text-align:center;letter-spacing:-.3px;font-weight:800"></span>
            <button class="year-btn" style="padding:5px 11px;font-size:12px" onclick="chDietM(1)">‚ñ∂</button>
          </div>
          <div class="diet-cal-header">
            <div class="diet-cal-dow">Lu</div><div class="diet-cal-dow">Ma</div>
            <div class="diet-cal-dow">Mi</div><div class="diet-cal-dow">Ju</div>
            <div class="diet-cal-dow">Vi</div><div class="diet-cal-dow">S√°</div>
            <div class="diet-cal-dow">Do</div>
          </div>
          <div class="diet-cal-grid" id="d-cal"></div>
        </div>
        <div class="card"><h2>Historial</h2><div class="log-list" id="d-list"></div></div>
      </div>
    </div>
  </div>

  <div class="footer">Datos guardados en tu navegador <span>‚úì</span></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
// ‚ïê‚ïê CONSTANTS ‚ïê‚ïê
const MONTHS   = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
const DOW      = ["Lu","Ma","Mi","Ju","Vi","S√°","Do"];
const DAY_NAMES= ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
const CYCLE    = [null,"green","yellow","red"];
const K        = { gym:"gt-gym", w:"gt-weight", d:"gt-diet", th:"gt-theme", pay:"gt-pay", rut:"gt-rutina", pesos:"gt-pesos" };
const RECUR_LABEL = {none:"Una sola vez",monthly:"Mensual",bimonthly:"Cada 2 meses",yearly:"Anual"};

// ‚ïê‚ïê STATE ‚ïê‚ïê
let gymD={}, wD=[], dD={}, payD=[], rutD={}, pesosD={};
let gYear=new Date().getFullYear();
let dYear=new Date().getFullYear(), dMonth=new Date().getMonth();
let dStatus=null, selectedRecur="none";
let wChart=null, editingDay=0;

// ‚ïê‚ïê STORAGE ‚ïê‚ïê
function load(){
  try{gymD=JSON.parse(localStorage.getItem(K.gym)||"{}");}catch(_){}
  try{wD=JSON.parse(localStorage.getItem(K.w)||"[]");}catch(_){}
  try{dD=JSON.parse(localStorage.getItem(K.d)||"{}");}catch(_){}
  try{payD=JSON.parse(localStorage.getItem(K.pay)||"[]");}catch(_){}
  try{pesosD=JSON.parse(localStorage.getItem(K.pesos)||"{}");}catch(_){}
  try{
    const raw=JSON.parse(localStorage.getItem(K.rut)||"{}");
    // Migrar formato viejo (strings) al nuevo (objetos)
    Object.keys(raw).forEach(k=>{
      if(Array.isArray(raw[k])){
        raw[k]=raw[k].map(e=>{
          if(typeof e==="string") return {name:e,series:3,reps:10};
          return e;
        });
      }
    });
    rutD=raw;
  }catch(_){}
  applyTheme(localStorage.getItem(K.th)||"dark");
}
function sv(k,v){localStorage.setItem(k,JSON.stringify(v));}
function daysIn(y,m){return new Date(y,m+1,0).getDate();}
function firstDay(y,m){let d=new Date(y,m,1).getDay();return d===0?6:d-1;}

// ‚ïê‚ïê THEME ‚ïê‚ïê
function applyTheme(th){
  document.documentElement.setAttribute("data-theme",th);
  localStorage.setItem(K.th,th);
  document.getElementById("th-dark").classList.toggle("active",th==="dark");
  document.getElementById("th-light").classList.toggle("active",th==="light");
}
function toggleTheme(){
  applyTheme(document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark");
  renderWChart();
}

// ‚ïê‚ïê TABS ‚ïê‚ïê
function showTab(t){
  ["gym","rutina","pagos","peso","dieta"].forEach(s=>{
    document.getElementById("sec-"+s).classList.toggle("active",s===t);
  });
  document.querySelectorAll(".tab-btn").forEach((b,i)=>{
    b.classList.toggle("active",["gym","rutina","pagos","peso","dieta"][i]===t);
  });
  if(t==="peso")   renderW();
  if(t==="dieta")  renderD();
  if(t==="pagos")  renderPayments();
  if(t==="rutina") renderRutina();
}

// ‚ïê‚ïê PAYMENT ALERTS ‚ïê‚ïê
function getDaysUntil(dateStr){
  const t=new Date(); t.setHours(0,0,0,0);
  return Math.round((new Date(dateStr+"T00:00:00")-t)/(864e5));
}

function nextOccurrence(dateStr,recur){
  const today=new Date(); today.setHours(0,0,0,0);
  let d=new Date(dateStr+"T00:00:00");
  if(recur==="none") return d;
  while(d<today){
    if(recur==="monthly")      d.setMonth(d.getMonth()+1);
    else if(recur==="bimonthly") d.setMonth(d.getMonth()+2);
    else if(recur==="yearly")  d.setFullYear(d.getFullYear()+1);
    else break;
  }
  return d;
}

function checkPaymentAlerts(){
  const urgent=[], soon=[];
  payD.forEach(p=>{
    const next=nextOccurrence(p.date,p.recur);
    const days=getDaysUntil(next.toISOString().split("T")[0]);
    if(days<=0)  urgent.push({...p,days,nextDate:next});
    else if(days<=7) soon.push({...p,days,nextDate:next});
  });

  // Siempre actualizar badge
  const tabPayos=document.getElementById("tab-pagos");
  let badge=tabPayos.querySelector(".tab-badge");
  if(urgent.length>0||soon.length>0){
    if(!badge){badge=document.createElement("span");badge.className="tab-badge";tabPayos.appendChild(badge);}
  } else {
    if(badge) badge.remove();
    closeAlert();
    return;
  }

  if(urgent.length>0){
    const items=urgent.map(p=>{
      const [y,m,d]=p.nextDate.toISOString().split("T")[0].split("-");
      return `<div class="modal-pay-item danger">
        <div><div class="modal-pay-name">${p.name}</div><div class="modal-pay-meta">${p.days===0?"Vence hoy":"Venci√≥ hace "+Math.abs(p.days)+" d√≠a"+(Math.abs(p.days)>1?"s":"")}</div></div>
        <div class="modal-pay-right">
          ${p.amount?`<div class="modal-pay-amount" style="color:var(--danger)">${p.currency||"$"}${p.amount}</div>`:""}
          <span class="modal-pay-badge danger">${p.days===0?"¬°Hoy!":"Vencido"}</span>
        </div>
      </div>`;
    }).join("");
    document.getElementById("modal-icon").textContent="üö®";
    document.getElementById("modal-title").textContent="¬°Pago pendiente!";
    document.getElementById("modal-subtitle").textContent="Ten√©s "+urgent.length+" pago"+(urgent.length>1?"s que vencieron o vencen hoy":" que vence hoy")+".";
    document.getElementById("modal-pay-list").innerHTML=items;
    document.getElementById("pay-modal").classList.add("open");
    showBanner("danger","üö®","¬°"+urgent.length+" pago"+(urgent.length>1?"s pendientes":"")+" pendiente!",
      urgent.map(p=>p.name).join(", "));
  } else if(soon.length>0){
    showBanner("warn","‚ö†Ô∏è","Pr√≥ximo pago en "+soon[0].days+" d√≠a"+(soon[0].days>1?"s":""),
      soon.map(p=>`${p.name}${p.amount?" ¬∑ "+(p.currency||"$")+p.amount:""}`).join("  ¬∑  "));
  }
}

function showBanner(type,icon,title,body){
  const el=document.getElementById("global-alert");
  el.className=type;
  document.getElementById("alert-icon").textContent=icon;
  document.getElementById("alert-title").textContent=title;
  document.getElementById("alert-body").textContent=body;
  el.style.display="flex";
  document.getElementById("app-content").style.marginTop=el.offsetHeight+"px";
}

function closeAlert(){
  const el=document.getElementById("global-alert");
  el.style.display="none";
  document.getElementById("app-content").style.marginTop="0";
}

function closeModal(){
  document.getElementById("pay-modal").classList.remove("open");
}

// ‚ïê‚ïê PAYMENTS ‚ïê‚ïê
function selRecur(val,btn){
  selectedRecur=val;
  document.querySelectorAll(".recur-btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

function addPayment(){
  const name=document.getElementById("pay-name").value.trim();
  const amount=parseFloat(document.getElementById("pay-amount").value)||0;
  const currency=document.getElementById("pay-currency").value.trim()||"$";
  const date=document.getElementById("pay-date").value;
  const notes=document.getElementById("pay-notes").value.trim();
  if(!name||!date){alert("Complet√° el nombre y la fecha.");return;}
  payD.push({id:Date.now(),name,amount,currency,date,recur:selectedRecur,notes});
  sv(K.pay,payD);
  document.getElementById("pay-name").value="";
  document.getElementById("pay-amount").value="";
  document.getElementById("pay-notes").value="";
  selectedRecur="none";
  document.querySelectorAll(".recur-btn").forEach((b,i)=>b.classList.toggle("active",i===0));
  renderPayments();
  checkPaymentAlerts();
}

function deletePayment(id){
  payD=payD.filter(p=>p.id!==id);
  sv(K.pay,payD);
  renderPayments();
  checkPaymentAlerts();
}

function markPaid(id){
  const p=payD.find(x=>x.id===id);
  if(!p) return;
  if(p.recur==="none"){deletePayment(id);return;}
  const next=nextOccurrence(p.date,p.recur);
  if(p.recur==="monthly")      next.setMonth(next.getMonth()+1);
  else if(p.recur==="bimonthly") next.setMonth(next.getMonth()+2);
  else if(p.recur==="yearly")  next.setFullYear(next.getFullYear()+1);
  p.date=next.toISOString().split("T")[0];
  sv(K.pay,payD);
  renderPayments();
  checkPaymentAlerts();
}

function renderPayments(){
  const list=document.getElementById("pay-list");
  if(payD.length===0){
    list.innerHTML='<div style="color:var(--text3);font-size:12px;text-align:center;padding:24px">Sin pagos registrados a√∫n</div>';
    return;
  }
  const sorted=[...payD]
    .map(p=>({...p,nextDate:nextOccurrence(p.date,p.recur)}))
    .sort((a,b)=>a.nextDate-b.nextDate);

  list.innerHTML=sorted.map(p=>{
    const days=getDaysUntil(p.nextDate.toISOString().split("T")[0]);
    const [y,m,d]=p.nextDate.toISOString().split("T")[0].split("-");
    const dateStr=`${d}/${m}/${y}`;
    let itemCls="",badgeCls="ok",badgeTxt="";
    if(days<0)       {itemCls="urgent";badgeCls="danger";badgeTxt=`Venci√≥ hace ${Math.abs(days)}d`;}
    else if(days===0){itemCls="urgent";badgeCls="danger";badgeTxt="¬°Hoy!";}
    else if(days<=7) {itemCls="soon";  badgeCls="warn";  badgeTxt=`En ${days} d√≠as`;}
    else             {itemCls="";      badgeCls="ok";    badgeTxt=`En ${days} d√≠as`;}
    return `<div class="pay-item ${itemCls}">
      <div class="pay-left">
        <div class="pay-name">${p.name}</div>
        <div class="pay-meta">üìÖ ${dateStr} &nbsp;¬∑&nbsp; ${RECUR_LABEL[p.recur]||p.recur}</div>
        ${p.notes?`<div class="pay-meta" style="font-family:'Space Grotesk',sans-serif">üìù ${p.notes}</div>`:""}
      </div>
      <div class="pay-right">
        ${p.amount?`<span class="pay-amount">${p.currency}${p.amount}</span>`:""}
        <span class="pay-badge ${badgeCls}">${badgeTxt}</span>
        <div class="pay-actions">
          <button class="btn-paid" onclick="markPaid(${p.id})">‚úì Pagado</button>
          <button class="btn-del"  onclick="deletePayment(${p.id})">‚úï</button>
        </div>
      </div>
    </div>`;
  }).join("");
}

// ‚ïê‚ïê RUTINA ‚ïê‚ïê
// Estructura de ejercicio: {name, series, reps, peso} ‚Äî peso se guarda por d√≠a de sesi√≥n
// rutD[dayIdx] = [{name, series, reps}]
// pesosD[dateStr][dayIdx][exIdx] = kg

function todayDayIdx(){const d=new Date().getDay();return d===0?6:d-1;}

function renderRutina(){
  const ti=todayDayIdx();
  const todayStr=new Date().toISOString().split("T")[0];
  document.getElementById("today-day-name").textContent=DAY_NAMES[ti];
  const exs=rutD[ti]||[];
  const exBox=document.getElementById("today-exercises");
  if(exs.length===0){
    exBox.innerHTML='<div style="color:var(--text2);font-size:13px;opacity:.7">No ten√©s ejercicios para hoy. Configur√° tu rutina abajo üëá</div>';
  } else {
    const dayPesos=(pesosD[todayStr]&&pesosD[todayStr][ti])||{};
    exBox.innerHTML=`<div class="exercise-list">${exs.map((e,i)=>{
      const p=dayPesos[i]||"";
      return `<div class="exercise-chip">
        <span class="ex-num">${i+1}.</span>
        <span class="ex-name">${e.name}</span>
        <div class="ex-pills">
          <span class="ex-pill">${e.reps} reps</span>
          <span class="ex-pill">${e.series} series</span>
          <div class="ex-weight-inline">
            <input class="ex-weight-input" type="number" min="0" step="0.5" placeholder="‚Äî" value="${p}" title="Peso usado (kg)" onchange="savePeso('${todayStr}',${ti},${i},this.value)"/>
            <span class="ex-weight-unit">kg</span>
          </div>
        </div>
      </div>`;
    }).join("")}</div>`;
  }
  const tabs=document.getElementById("day-tabs");
  tabs.innerHTML=DAY_NAMES.map((n,i)=>`<button class="day-tab${i===editingDay?" active":""}" onclick="selectEditDay(${i})">${n.slice(0,3)}</button>`).join("");
  renderDayEditor();
  renderFullWeek();
}

function savePeso(dateStr,dayIdx,exIdx,val){
  if(!pesosD[dateStr])pesosD[dateStr]={};
  if(!pesosD[dateStr][dayIdx])pesosD[dateStr][dayIdx]={};
  const v=parseFloat(val);
  if(!isNaN(v)&&v>0) pesosD[dateStr][dayIdx][exIdx]=v;
  else delete pesosD[dateStr][dayIdx][exIdx];
  sv(K.pesos,pesosD);
}

function selectEditDay(i){editingDay=i;renderRutina();}

function renderDayEditor(){
  document.getElementById("editing-day-label").textContent=`Ejercicios del ${DAY_NAMES[editingDay]}:`;
  const exs=rutD[editingDay]||[];
  const ed=document.getElementById("exercise-editor");
  if(exs.length===0){
    ed.innerHTML='<div style="color:var(--text3);font-size:12px;padding:8px">Sin ejercicios. Agreg√° uno abajo.</div>';
    return;
  }
  ed.innerHTML=exs.map((e,i)=>`
    <div class="ex-row">
      <span class="ex-num" style="color:var(--accent);min-width:20px;font-size:12px;padding-top:8px">${i+1}.</span>
      <div class="ex-row-fields">
        <input class="form-input ex-input-name" value="${(e.name||"").replace(/"/g,'&quot;')}" placeholder="Ejercicio" onchange="updateExercise(${i},'name',this.value)" style="width:100%"/>
        <input class="form-input ex-input-sm" type="number" min="1" value="${e.reps||""}" placeholder="Reps" onchange="updateExercise(${i},'reps',this.value)"/>
        <input class="form-input ex-input-sm" type="number" min="1" value="${e.series||""}" placeholder="Series" onchange="updateExercise(${i},'series',this.value)"/>
      </div>
      <button class="btn-del" onclick="removeExercise(${i})" style="padding-top:8px">‚úï</button>
    </div>`).join("");
}

function addExercise(){
  const name=document.getElementById("new-ex-name").value.trim();
  const series=parseInt(document.getElementById("new-ex-series").value)||4;
  const reps=parseInt(document.getElementById("new-ex-reps").value)||10;
  if(!name)return;
  if(!rutD[editingDay])rutD[editingDay]=[];
  rutD[editingDay].push({name,series,reps});
  sv(K.rut,rutD);
  document.getElementById("new-ex-name").value="";
  document.getElementById("new-ex-series").value="";
  document.getElementById("new-ex-reps").value="";
  renderRutina();
}

function updateExercise(idx,field,val){
  if(!rutD[editingDay]||!rutD[editingDay][idx])return;
  if(field==="series"||field==="reps") rutD[editingDay][idx][field]=parseInt(val)||1;
  else rutD[editingDay][idx][field]=val;
  sv(K.rut,rutD);
}

function removeExercise(idx){
  if(!rutD[editingDay])return;
  rutD[editingDay].splice(idx,1);
  sv(K.rut,rutD);
  renderRutina();
}

function renderFullWeek(){
  document.getElementById("full-week").innerHTML=DAY_NAMES.map((n,i)=>{
    const exs=rutD[i]||[],isToday=i===todayDayIdx();
    return `<div style="background:var(--bg3);border-radius:10px;padding:13px 16px;border:1px solid ${isToday?"var(--accent)":"var(--border)"}">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:${exs.length?8:0}px">
        <span style="font-family:'Syne',sans-serif;font-size:15px;letter-spacing:-.3px;font-weight:800;color:${isToday?"var(--accent)":"var(--text)"}">${n}</span>
        ${isToday?'<span style="font-size:9px;background:var(--accent-bg);color:var(--accent);padding:2px 9px;border-radius:20px;font-weight:700;letter-spacing:1px">HOY</span>':""}
        <span style="margin-left:auto;font-size:11px;color:var(--text3);font-weight:600">${exs.length?exs.length+" ejercicio"+(exs.length>1?"s":""):"Descanso"}</span>
      </div>
      ${exs.length?`<div style="display:flex;flex-direction:column;gap:5px">${exs.map(e=>`
        <div style="display:flex;align-items:center;gap:8px">
          <span style="color:var(--accent);font-size:10px">‚ñ∏</span>
          <span style="font-size:12px;color:var(--text2);flex:1">${e.name}</span>
          <span style="font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--text3)">${e.reps}√ó${e.series}</span>
        </div>`).join("")}</div>`:""}
    </div>`;
  }).join("");
}

// ‚ïê‚ïê PESO ‚ïê‚ïê
function addWeight(){
  const date=document.getElementById("w-date").value;
  const kg=parseFloat(document.getElementById("w-kg").value);
  const note=document.getElementById("w-note").value.trim();
  if(!date||isNaN(kg)){alert("Complet√° la fecha y el peso.");return;}
  wD=wD.filter(e=>e.date!==date);wD.push({date,kg,note});
  wD.sort((a,b)=>a.date.localeCompare(b.date));
  sv(K.w,wD);document.getElementById("w-kg").value="";document.getElementById("w-note").value="";
  renderW();
}
function delWeight(date){wD=wD.filter(e=>e.date!==date);sv(K.w,wD);renderW();}
function renderW(){
  const list=document.getElementById("w-list");list.innerHTML="";
  if(wD.length===0){list.innerHTML='<div style="color:var(--text3);font-size:12px;text-align:center;padding:18px">Sin registros a√∫n</div>';}
  else{[...wD].reverse().forEach(e=>{const[y,m,d]=e.date.split("-");const item=document.createElement("div");item.className="log-item";item.innerHTML=`<div class="log-item-left"><span class="log-val">${e.kg} kg</span>${e.note?`<span class="log-note">${e.note}</span>`:""}<span class="log-date">${d}/${m}/${y}</span></div><button class="btn-del" onclick="delWeight('${e.date}')">‚úï</button>`;list.appendChild(item);});}
  if(wD.length>0){
    const kgs=wD.map(e=>e.kg),cur=wD[wD.length-1].kg;
    document.getElementById("w-cur").textContent=cur;
    document.getElementById("w-min").textContent=Math.min(...kgs);
    document.getElementById("w-max").textContent=Math.max(...kgs);
    if(wD.length>=2){const diff=(cur-wD[0].kg).toFixed(1),c=diff<0?"var(--green)":diff>0?"var(--red)":"var(--yellow)";document.getElementById("w-change").innerHTML=`Cambio total: <span style="color:${c};font-weight:600">${diff>0?"+":""}${diff} kg</span>`;}
    else document.getElementById("w-change").textContent="";
  } else{["w-cur","w-min","w-max"].forEach(id=>document.getElementById(id).textContent="‚Äî");document.getElementById("w-change").textContent="";}
  renderWChart();
}
function renderWChart(){
  const dark=document.documentElement.getAttribute("data-theme")==="dark";
  const gc=dark?"#ffffff10":"#00000010",tc=dark?"#7a8fa6":"#4a6885";
  if(wChart){wChart.destroy();wChart=null;}
  const ctx=document.getElementById("wChart");if(!ctx)return;
  wChart=new Chart(ctx,{type:"line",data:{labels:wD.map(e=>{const[y,m,d]=e.date.split("-");return`${d}/${m}`;}),datasets:[{data:wD.map(e=>e.kg),borderColor:"#00d4ff",backgroundColor:"rgba(0,212,255,0.08)",borderWidth:2,pointBackgroundColor:"#00d4ff",pointRadius:4,tension:0.4,fill:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:tc,font:{size:10,family:"JetBrains Mono"}},grid:{color:gc}},y:{ticks:{color:tc,font:{size:10,family:"JetBrains Mono"}},grid:{color:gc}}}}});
}

// ‚ïê‚ïê DIETA ‚ïê‚ïê
function selDS(s){dStatus=s;["green","yellow","red"].forEach(c=>{document.getElementById("dsb-"+c).className="diet-status-btn"+(c===s?" sel-"+c:"");});}
function chDietY(d){dYear+=d;renderDStats();document.getElementById("d-year").textContent=dYear;}
function chDietM(d){dMonth+=d;if(dMonth<0){dMonth=11;dYear--;}if(dMonth>11){dMonth=0;dYear++;}renderDCal();}
function addDiet(){
  const date=document.getElementById("d-date").value;
  const food=document.getElementById("d-food").value.trim();
  const notes=document.getElementById("d-notes").value.trim();
  if(!date){alert("Seleccion√° una fecha.");return;}
  if(!dStatus){alert("Seleccion√° si seguiste la dieta.");return;}
  dD[date]={status:dStatus,food,notes};sv(K.d,dD);
  document.getElementById("d-food").value="";document.getElementById("d-notes").value="";
  dStatus=null;["green","yellow","red"].forEach(c=>document.getElementById("dsb-"+c).className="diet-status-btn");
  renderD();
}
function delDiet(date){delete dD[date];sv(K.d,dD);renderD();}
function renderD(){document.getElementById("d-year").textContent=dYear;renderDStats();renderDCal();renderDList();}
function renderDStats(){
  let g=0,y=0,r=0;
  for(const[k,v]of Object.entries(dD)){if(!k.startsWith(dYear+"-"))continue;if(v.status==="green")g++;else if(v.status==="yellow")y++;else if(v.status==="red")r++;}
  document.getElementById("ds-g").textContent=g;document.getElementById("ds-y").textContent=y;document.getElementById("ds-r").textContent=r;
}
function renderDCal(){
  document.getElementById("d-month-lbl").textContent=`${MONTHS[dMonth]} ${dYear}`;
  const grid=document.getElementById("d-cal");grid.innerHTML="";
  const days=daysIn(dYear,dMonth),first=firstDay(dYear,dMonth);
  for(let i=0;i<first;i++){const e=document.createElement("div");e.className="diet-dot";e.style.opacity="0";grid.appendChild(e);}
  for(let d=1;d<=days;d++){
    const key=`${dYear}-${String(dMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const entry=dD[key];const dot=document.createElement("div");
    dot.className="diet-dot"+(entry?" "+entry.status:"");
    dot.title=entry?`${d}: ${entry.status==="green"?"‚úÖ Completa":entry.status==="yellow"?"‚ö° A medias":"‚ùå No segu√≠"}${entry.food?"\nüçΩ "+entry.food:""}`:String(d);
    grid.appendChild(dot);
  }
}
function renderDList(){
  const list=document.getElementById("d-list");list.innerHTML="";
  const entries=Object.entries(dD).sort((a,b)=>b[0].localeCompare(a[0])).slice(0,40);
  if(entries.length===0){list.innerHTML='<div style="color:var(--text3);font-size:12px;text-align:center;padding:18px">Sin registros a√∫n</div>';return;}
  entries.forEach(([date,v])=>{
    const[y,m,d]=date.split("-");
    const bl={green:"‚úÖ Completa",yellow:"‚ö° A medias",red:"‚ùå No segu√≠"}[v.status];
    const item=document.createElement("div");item.className="diet-log-item";
    item.innerHTML=`<div class="diet-log-header"><span class="diet-log-date">${d}/${m}/${y}</span><div style="display:flex;align-items:center;gap:8px"><span class="diet-badge ${v.status}">${bl}</span><button class="btn-del" onclick="delDiet('${date}')">‚úï</button></div></div>${v.food?`<div class="diet-log-food">üçΩ ${v.food}</div>`:""}${v.notes?`<div class="diet-log-notes">üìù ${v.notes}</div>`:""}`;
    list.appendChild(item);
  });
}

// ‚ïê‚ïê GYM ‚ïê‚ïê
function changeYear(d){gYear+=d;renderGym();}
function toggleDay(m,d){
  const k=`${gYear}-${m}-${d}`;
  const cur=gymD[k]??null,next=CYCLE[(CYCLE.indexOf(cur)+1)%CYCLE.length];
  if(next===null)delete gymD[k];else gymD[k]=next;
  sv(K.gym,gymD);renderGym();
}
function renderGym(){
  document.getElementById("year-display").textContent=gYear;
  const today=new Date();let g=0,y=0,r=0;
  for(const[k,v]of Object.entries(gymD)){if(!k.startsWith(gYear+"-"))continue;if(v==="green")g++;else if(v==="yellow")y++;else if(v==="red")r++;}
  document.getElementById("sg").textContent=g;document.getElementById("sy").textContent=y;document.getElementById("sr").textContent=r;
  const grid=document.getElementById("months-grid");grid.innerHTML="";
  MONTHS.forEach((mn,mi)=>{
    const days=daysIn(gYear,mi),first=firstDay(gYear,mi);
    const isCur=today.getFullYear()===gYear&&today.getMonth()===mi;
    let mg=0,my=0,mr=0;
    for(let d=1;d<=days;d++){const s=gymD[`${gYear}-${mi}-${d}`];if(s==="green")mg++;else if(s==="yellow")my++;else if(s==="red")mr++;}
    let mini="";
    if(mg>0)mini+=`<span style="color:var(--green)">üí™${mg}</span>`;
    if(my>0)mini+=`<span style="color:var(--yellow)"> üòÖ${my}</span>`;
    if(mr>0)mini+=`<span style="color:var(--red)"> ‚ùå${mr}</span>`;
    const card=document.createElement("div");card.className="month-card"+(isCur?" current":"");
    card.innerHTML=`<div class="month-header"><div><div class="month-name${isCur?" current-name":""}">${mn}</div><div class="month-mini-stats">${mini}</div></div>${isCur?'<span class="current-badge">ACTUAL</span>':""}</div><div class="dow-header">${DOW.map(d=>`<div class="dow-cell">${d}</div>`).join("")}</div><div class="days-grid" id="dg-${mi}"></div>`;
    grid.appendChild(card);
    const dg=document.getElementById(`dg-${mi}`);
    for(let i=0;i<first;i++){const e=document.createElement("div");e.className="day-cell empty";dg.appendChild(e);}
    for(let d=1;d<=days;d++){
      const key=`${gYear}-${mi}-${d}`,st=gymD[key]??null,isT=isCur&&today.getDate()===d;
      const cell=document.createElement("div");
      cell.className="day-cell"+(st?" "+st:"")+(isT?" today":"");
      cell.textContent=d;cell.title=st?({green:"Fui üí™",yellow:"A medias üòÖ",red:"No fui ‚ùå"}[st]):"Sin marcar";
      cell.addEventListener("click",()=>toggleDay(mi,d));dg.appendChild(cell);
    }
  });
}

// ‚ïê‚ïê INIT ‚ïê‚ïê
const todayStr=new Date().toISOString().split("T")[0];
load();
document.getElementById("w-date").value=todayStr;
document.getElementById("d-date").value=todayStr;
document.getElementById("pay-date").value=todayStr;
editingDay=todayDayIdx();
renderGym();
setTimeout(checkPaymentAlerts,300);
</script>
</body>
</html>
